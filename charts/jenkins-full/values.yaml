image:
  registry: ghcr.io
nameOverride: "jenkins"
fullnameOverride: ""
pullPolicy: IfNotPresent
plugins:
# if "Values.eventProxy.enable" is "true", will use sidecar model to send event first;
# if "receiver" not empty, will use receiver to send event;
# otherwise, will send event to "http://amamba-devops-server.targetNamespace:80/apis/internel.amamba.io/devops/pipeline/v1alpha1/webhooks/jenkins".
  eventDispatcher:
    receiver: ""

Master:
  StatefulSet:
    Enabled: false
    Replicas: 1
    # StatefulSetUpdateStrategy must be 'RollingUpdate' or 'OnDelete'
    UpdateStrategy: RollingUpdate
    # Name of the Kubernetes scheduler to use
    SchedulerName: ""
  Name: jenkins-master
  Image: "amamba-io/jenkins"
  ImageTag: "latest-2.502"
  ImagePullPolicy: "IfNotPresent"
  ImagePullSecret: ""
  Component: "jenkins-master"
  TZ: "Asia/Shanghai"
  UseSecurity: true
  HostNetworking: false
  AdminUser: admin
  AdminPassword: ""
  resources: {}
    # requests:
    #   cpu: "1"
    #   memory: "799Mi"
    # limits:
    #   cpu: "2"
    #   memory: "4096Mi"

  UsePodSecurityContext: true
  JavaOpts: |-
    -XX:+PrintFlagsFinal
    -XX:MaxRAMPercentage=70.0
    -XX:MinHeapFreeRatio=8
    -XX:MaxHeapFreeRatio=15
    -XX:MinRAMPercentage=20.0
    -XX:-UseAdaptiveSizePolicy
    -XX:-ShrinkHeapInSteps
    -Dhudson.slaves.NodeProvisioner.initialDelay=20
    -Dhudson.slaves.NodeProvisioner.MARGIN=50
    -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85
    -Dhudson.model.LoadStatistics.clock=5000
    -Dhudson.model.LoadStatistics.decay=0.2
    -Dhudson.slaves.NodeProvisioner.recurrencePeriod=5000
    -Dhudson.security.csrf.DefaultCrumbIssuer.EXCLUDE_SESSION_ID=true
    -Dio.jenkins.plugins.casc.ConfigurationAsCode.initialDelay=10000
    -Djenkins.install.runSetupWizard=false  
    -XX:+UseStringDeduplication
    -XX:+ParallelRefProcEnabled
    -XX:+DisableExplicitGC
    -XX:+UnlockDiagnosticVMOptions
    -XX:+UnlockExperimentalVMOptions
    -Dorg.jenkinsci.plugins.scriptsecurity.scripts.ScriptApproval.ALLOW_ADMIN_APPROVAL_ENABLED=true
    -Dorg.jenkinsci.plugins.scriptsecurity.scripts.ScriptApproval.ADMIN_AUTO_APPROVAL_ENABLED=true
  Deploy:
    NotWithApiServer: false
    # If the cluster where jenkins is deployed and amamba-apiserver are not in the same cluster, you need to fill in this item
    JenkinsHost: ""
  ServicePort: 80
  ServiceType: ClusterIP
  NodePort:
  ServiceAnnotations: {}
  Casc:
    # Maximum number of parallel pipelines
    maxParallelRuns: 2

  # Ingress:
  #   Annotations:
  #     nginx.ingress.kubernetes.io/ssl-redirect: "false"
  #     nginx.ingress.kubernetes.io/proxy-body-size: 50m
  #     nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
  #     ingress.kubernetes.io/ssl-redirect: "false"
  #     ingress.kubernetes.io/proxy-body-size: 50m
  #     ingress.kubernetes.io/proxy-request-buffering: "off"
  HostName:

  HealthProbes: true
  livenessProbe:
    initialDelaySeconds: 90
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 12
    successThreshold: 1
  readinessProbe:
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1
  SlaveListenerPort: 50000
  DisabledAgentProtocols:
    - JNLP-connect
    - JNLP2-connect
  CSRF:
    DefaultCrumbIssuer:
      Enabled: true
      ProxyCompatability: true
  CLI: false
  # Kubernetes service type for the JNLP slave service
  # SETTING THIS TO "LoadBalancer" IS A HUGE SECURITY RISK: https://github.com/kubernetes/charts/issues/1341
  SlaveListenerServiceType: ClusterIP
  SlaveListenerServiceAnnotations: {}
  LoadBalancerSourceRanges:
  - 0.0.0.0/0

  ContainerEnv:
    - name: CASC_JENKINS_CONFIG
      value: "/var/jenkins_home/casc_configs/"
    - name: CASC_MERGE_STRATEGY
      value: override
    - name: kubernetes.connection.timeout
      value: "60000"
    - name: kubernetes.request.timeout
      value: "60000"
    - name: EMAIL_SMTP_HOST
      value: "mail.example.com"
    - name: EMAIL_SMTP_PORT
      value: "465"
    - name: EMAIL_USE_SSL
      value: "false"
    - name: EMAIL_FROM_NAME
      value: "Jenkins"
    - name: EMAIL_FROM_ADDR
      value: "admin@example.com"
    - name: EMAIL_FROM_PASS
      value: "P@ssw0rd"

  InitScripts:
#    TimeZone:
#      System.setProperty('org.apache.commons.jelly.tags.fmt.timeZone', 'Asia/Shanghai')

    Mailer: |-
      import jenkins.model.*

      def env = System.getenv()

      def emailFromName = env.EMAIL_FROM_NAME
      def emailFromAddr = env.EMAIL_FROM_ADDR

      def locationConfig = JenkinsLocationConfiguration.get()
      locationConfig.adminAddress = "${emailFromName} <${emailFromAddr}>"
      locationConfig.save()

      def mailer = Jenkins.instance.getDescriptor("hudson.tasks.Mailer")
      mailer.setSmtpAuth(emailFromAddr, env.EMAIL_FROM_PASS)
      mailer.setReplyToAddress("no-reply@k8s.io")
      mailer.setSmtpHost(env.EMAIL_SMTP_HOST)
      mailer.setUseSsl(env.EMAIL_USE_SSL.toBoolean())
      mailer.setSmtpPort(env.EMAIL_SMTP_PORT)
      mailer.save()

    K8sCredentials: |-
      import com.cloudbees.plugins.credentials.CredentialsScope
      import com.cloudbees.plugins.credentials.SystemCredentialsProvider
      import com.cloudbees.plugins.credentials.domains.Domain
      import org.csanchez.jenkins.plugins.kubernetes.ServiceAccountCredential

      def addKubeCredential(String credentialId) {
        def kubeCredential = new ServiceAccountCredential(CredentialsScope.GLOBAL, credentialId, 'Kubernetes service account')
        SystemCredentialsProvider.getInstance().getStore().addCredentials(Domain.global(), kubeCredential)
      }

      addKubeCredential('k8s-service-account')
    ReloadCASC: |-
      import io.jenkins.plugins.casc.ConfigurationAsCode

      try {
        ConfigurationAsCode.get().configure()
        println("reload casc success")
      } catch (Throwable t) {
        println("load casc failed")
        t.printStackTrace()
      }
  CustomConfigMap: false
  # By default, the configMap is only used to set the initial config the first time
  # that the chart is installed.  Setting `OverwriteConfig` to `true` will overwrite
  # the jenkins config with the contents of the configMap every time the pod starts.
  OverwriteConfig: false
  # Node labels and tolerations for pod assignment
  # ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector
  # ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#taints-and-tolerations-beta-feature
  NodeSelector: {}
  Tolerations: {}
  PodAnnotations: {}

  Ingress:
    ApiVersion: networking.k8s.io/v1
    Annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"

    TLS:
    # - secretName: jenkins.cluster.local
    #   hosts:
    #     - jenkins.cluster.local
  metrics:
    enabled: false
    serviceMonitor:
      enabled: false
      additionalLabels: {}

  SecurityRealm:
    clientID: ""
    clientSecret: ""
    disableSslVerification: true
    wellKnownOpenIDConfigurationUrl: ""
    enableExternalAuth: false
    externalAuthServiceUrl: ""
    userNameField: "preferred_username"
    idStrategy: "caseSensitive"
  AuthorizationStrategy:
    globalMatrix:
      entries:
        - group:
            name: "authenticated"
            permissions:
              - "Job/Build"
              - "Job/Cancel"
              - "Job/Configure"
              - "Job/Create"
              - "Job/Delete"
              - "Job/Discover"
              - "Job/Move"
              - "Job/Read"
              - "Job/Workspace"
              - "Overall/Read"
              - "Run/Delete"
              - "Run/Update"
        - user:
            name: "admin"
            permissions:
              - "Overall/Administer"
        - user:
            name: "anonymous"
            permissions:
              - "Overall/Read"
Agent:
  Enabled: true
  Image: "amamba-io/inbound-agent"
  ImageTag: jdk21
  CustomJenkinsLabels: []
  Component: "jenkins-inbound-agent"
  Privileged: false
  WorkerNamespace:
  ResourceQuota:
    Enabled: false
  # Default resource settings for Jenkins agents running on Kubernetes
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"
  # You may want to change this to true while testing a new image
  AlwaysPullImage: false
  # Controls how agent pods are retained after the Jenkins build completes
  # Possible values: Always, Never, OnFailure
  PodRetention: Never
  # You can define the volumes that you want to mount for this container
  # Allowed types are: ConfigMap, EmptyDir, HostPath, Nfs, Pod, Secret
  # Configure the attributes as they appear in the corresponding Java class for that type
  # https://github.com/jenkinsci/kubernetes-plugin/tree/master/src/main/java/org/csanchez/jenkins/plugins/kubernetes/volumes
  volumes:
  # - type: Secret
  #   secretName: mysecret
  #   mountPath: /var/myapp/mysecret
  NodeSelector: {}
  # Key Value selectors. Ex:
  # jenkins-agent: v1

  # let relok8s to properly resolve agent images,just keep empty string
  relok8sPlaceholder: ""
  Builder:
    Base:
      Image: amamba-io/jenkins-agent-base
      ImageTag: latest
    NodeJs:
      Image: amamba-io/jenkins-agent-nodejs
      ImageTag: latest-16.20.2
      # Versions for auto generator Jenkins CASC Config and relock_k8s images.
      # must build image first.
      Versions:
        - latest-18.20.4
        - latest-20.17.0
    Maven:
      Image: amamba-io/jenkins-agent-maven
      ImageTag: latest-jdk8
      Versions:
        - latest-jdk11
        - latest-jdk17
        - latest-jdk21
    Golang:
      Image: amamba-io/jenkins-agent-go
      ImageTag: latest-1.22.6
      Versions:
        - latest-1.17.13
        - latest-1.18.10
        - latest-1.20.14
    Python:
      Image: amamba-io/jenkins-agent-python
      ImageTag: latest-3.8.19
      Versions:
        - latest-2.7.9
        - latest-3.10.9
        - latest-3.11.9
    ContainerRuntime: podman # Available values: docker, podman

Persistence:
  Enabled: true
  # if "-" use default sc.you can specify other sc,like: hwameistor-storage-lvm-hdd, hwameistor-storage-lvm-hdd-ha
  StorageClass: "-"
#  ExistingClaim: ""

  Annotations: {}
  AccessMode: ReadWriteOnce
  Size: 8Gi
  volumes:
    - name: casc-config
      configMap:
        name: jenkins-casc-config
  mounts:
    - name: casc-config
      mountPath: /var/jenkins_home/casc_configs
      readOnly: true

NetworkPolicy:
  # Enable creation of NetworkPolicy resources.
  Enabled: false
  # For Kubernetes v1.4, v1.5 and v1.6, use 'extensions/v1beta1'
  # For Kubernetes v1.7, use 'networking.k8s.io/v1'
  ApiVersion: networking.k8s.io/v1

## Install Default RBAC roles and bindings
rbac:
  install: true
  serviceAccountName: default
  # Role reference
  roleRef: cluster-admin
  # Role kind (RoleBinding or ClusterRoleBinding)
  roleBindingKind: ClusterRoleBinding

securityRealm:
  type: local # support values include local, ldap

eventProxy:
  enabled: false
  image:
    registry: release.daocloud.io
    repository: amamba/amamba-event-proxy
    tag: "v0.18.0-alpha.0"
  imagePullPolicy: IfNotPresent
  configMap:
    eventProxy:
      host: "amamba-devops-server.amamba-system:80"
      proto: "http"
      webhookUrl: "/apis/internel.amamba.io/devops/pipeline/v1alpha1/webhooks/jenkins"
      token: ""
    discardStrategy: retry
    timeout: 3000
    retryConfig:
      maxRetryTimes: 3
      retryBackoffDuration: 100
      retryBackoffMaxDuration: 5000
      retryMaxJitter: 1000
    rateLimiterConfig:
      qps: 1000
      burst: 100
  resources: {}
    #  requests:
    #    cpu: 100m
    #    memory: 100Mi
    #  limits:
    #    cpu: 200m
    #    memory: 200Mi

trace:
  enabled: false
  image:
    registry: ghcr.io
    repository: open-telemetry/opentelemetry-operator/autoinstrumentation-java
    tag: 1.17.0